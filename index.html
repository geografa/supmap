<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Best SUP Locations in OR/WA</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.css" rel="stylesheet" />

<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>
<link
rel="stylesheet"
href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css"
type="text/css"
/>
<!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>

<link rel="stylesheet" href="styles.css" type="text/css" />

<style>
	body { margin: 0; padding: 0; }
	#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
<div id="map"></div>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZ3JhZmEiLCJhIjoiY2ptYjNtZWxnMDBrdDNwbnVicGJzOWg2NyJ9.9OulyCe3kEqMAXPbx1mKUA';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/grafa/ckd6dcazo00l01is4jrzlodal',
    center: [-119.655,44.268],
    zoom: 6.5,
    hash: true
});

map.addControl(
    new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        marker: false,
        localGeocoder: forwardGeocoder,
        placeholder: "e.g Willamette Park"
    })
);

function forwardGeocoder(query) {
  var launches = map.querySourceFeatures('slipways', {
    sourceLayer: 'slipways'
  });

  if (launches) {
    // only list unique features from vector tiles
    var uniqueFeatures = getUniqueFeatures(launches, "name");
    var matchingFeatures = []
    for (i=0; i<uniqueFeatures.length; i++){
      var feature = uniqueFeatures[i]
      query.toLowerCase();
      if (feature.properties.name && feature.properties.name.toLowerCase().search(query.toLowerCase()) !== -1) {
        feature['place_name']= '🏄‍♀️ ' + feature.properties.name
        feature['center'] = feature.geometry.coordinates
        matchingFeatures.push(feature);
      }
    }
    return matchingFeatures;
  }
};

function getUniqueFeatures(array, comparatorProperty) {
    var existingFeatureKeys = {};
    // Because features come from tiled vector data, feature geometries may be split
    // or duplicated across tile boundaries and, as a result, features may appear
    // multiple times in query results.
    var uniqueFeatures = array.filter(function(el) {
        if (existingFeatureKeys[el.properties[comparatorProperty]]) {
            return false;
        } else {
            existingFeatureKeys[el.properties[comparatorProperty]] = true;
            return true;
        }
    });
    return uniqueFeatures;
}

map.on('load', function() {
    map.addSource('slipways', {
        type: 'vector',
        url: 'mapbox://grafa.slipways'
    });

    map.addLayer({
        id: 'slipways2',
        source: 'slipways',
        'source-layer': 'slipways',
        type: 'symbol',
        layout: {
            // Set the label content to the
            // feature's `name` property
            // text-field: ['get', 'name'],
            'icon-image': 'dot-blue',
            'icon-size': [
                'interpolate', ['linear'], ['zoom'],
                0, 0.3,
                11, 0.5,
                15, 1
            ],
            'icon-allow-overlap': true
        },
    });

    // When a click event occurs on a feature in the places layer, open a popup at the
    // location of the feature, with description HTML from its properties.
    map.on('click', 'slipways2', function(e) {
        var coordinates = e.features[0].geometry.coordinates.slice();
        var description = '<strong>' + e.features[0].properties.name + '</strong><br>';

        // Ensure that if the map is zoomed out such that multiple
        // copies of the feature are visible, the popup appears
        // over the copy being pointed to.
        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }
        new mapboxgl.Popup()
            .setLngLat(coordinates)
            .setHTML(description)
            .addTo(map);
            
        map.flyTo({
            center: coordinates,
            pitch: 60,
            zoom:15,
            essential: true // this animation is considered essential with respect to prefers-reduced-motion
        });
    });

    // Change the cursor to a pointer when the mouse is over the places layer.
    map.on('mouseenter', 'slipways', function() {
        map.getCanvas().style.cursor = 'pointer';
    });

    // Change it back to a pointer when it leaves.
    map.on('mouseleave', 'slipways', function() {
        map.getCanvas().style.cursor = '';
    });
    forwardGeocoder();
});
</script>

</body>
</html>
